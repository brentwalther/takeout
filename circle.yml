machine:
  java:
    version: openjdk7
  environment:
    RAILS_ENV: test
    JRUBY_OPTS: -J-XX:+TieredCompilation -J-XX:TieredStopAtLevel=1 -J-noverify -X-C -Xcompile.invokedynamic=false --1.9 -J-Xmx2g

dependencies:
  cache_directories:
    - '../.rvm/rubies'

  override:
    - >
      case $CIRCLE_NODE_INDEX in
       0)
         rvm-exec 2.1.0 bash -c "bundle check --path=vendor/bundle || bundle install --path=vendor/bundle"
         ;;
       1)
         rvm-exec 2.2.0 bash -c "bundle check --path=vendor/bundle || bundle install --path=vendor/bundle"
         ;;
       2)
         rvm-exec 1.8.7-p302 bash -c "bundle check --path=vendor/bundle || bundle install --path=vendor/bundle"
         ;;
       3)
         rvm-exec jruby gem install bundler
         rvm-exec jruby bash -c "bundle check --path=vendor/bundle --gemfile Gemfile.java || bundle install --path=vendor/bundle --gemfile Gemfile.java"
         ;;
      esac
test:
  override:
    - case $CIRCLE_NODE_INDEX in 0) rvm-exec 2.1.0 bundle exec rspec ;; 1) rvm-exec 2.2.0-preview1 bundle exec rspec ;; 2) rvm-exec 1.8.7-p302 bundle exec rspec ;; 3) BUNDLE_GEMFILE=Gemfile.java rvm-exec jruby bundle exec rspec ;; esac:
        parallel: true